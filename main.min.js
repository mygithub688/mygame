//技能类
var Skill = (function(_super){
    function Skill(){
        Skill.super(this);
    }
    Skill.cached = false;
    Laya.class(Skill,"Skill",_super);
    var _proto = Skill.prototype;
    _proto.init = function(_type,_heroType,_camp){
        this.heroType = _heroType;
        this.camp = _camp;
        this.type = _type; //技能类型
        if(!Skill.cached){
        Skill.cached = true;
        //缓存技能1动画
        Laya.Animation.createFrames(["skill/skill1_0.png","skill/skill1_1.png","skill/skill1_2.png","skill/skill1_3.png","skill/skill1_2.png","skill/skill1_1.png","skill/skill1_4.png"],"skill1_boom");
        }
        this.playSkill();
    }

    _proto.playSkill = function(){
        this.body = new Laya.Animation();
        this.body.x = -50;
        this.body.width = 852;
        this.body.height = 400;
        this.body.scale(3,10);
        this.body.interval = 100;
        this.addChild(this.body);
        this.body.on(Laya.Event.COMPLETE,this,this.onPlayComplete);
        switch(this.type){
            case 1:
                this.body.play(0,false,"skill1_boom");
            break;
        }
    }
    _proto.onPlayComplete = function(){
        if(this.body){
            this.body.destroy();
        }
    }

    return Skill;

})(Laya.Sprite);


//游戏UI文件
var GameInfo = (function(_super){
    function GameInfo(){
        GameInfo.super(this);
        //注册按钮点击事件，点击后暂停游戏
        this.pauseBtn.on(Laya.Event.CLICK,this,this.onPauseBtnClick);
        //初始化UI显示
        this.reset();
    }
    //注册类
    Laya.class(GameInfo,"GameInfo",_super);
    var _proto = GameInfo.prototype;
    _proto.reset = function(){
        this.infoLabel.text = "";
        this.hp(5);
        this.level(0);
        this.score(0);
    }
    _proto.onPauseBtnClick = function(e){
        e.stopPropagation();
        //暂停游戏
        this.infoLabel.text = "游戏已暂停，点击任意地方恢复游戏";
        this.infoLabel.color = "#ffffff";
        pause();
        Laya.stage.once(Laya.Event.CLICK,this,this.onStageClick);
    }
    _proto.onStageClick = function(){
        this.infoLabel.text = "";
        resume();
    }
    //显示血量
    _proto.hp = function(value){
        this.hpLabel.text = "HP:"+value;
    }
    //显示关卡级别
    _proto.level = function(value){
        this.levelLabel.text = "Level:"+value;
    }
    //显示积分
    _proto.score = function(value){
        this.scoreLabel.text = "Score:"+value;
    }
    //boss关
    _proto.bossComing = function(){
        this.infoLabel.text = "全民偶像练习生来袭！！！";
        this.infoLabel.color = "red";
        this.infoLabel.fontSize = 30;
        Laya.timer.once(3000, this, this.onComplete);
    }
    //进入下一关
    _proto.nextTage = function(value){
        this.infoLabel.text = "第" +value+ "关";
        this.infoLabel.color = "#ffffff";
        Laya.timer.once(3000, this, this.onComplete);
    }
    _proto.onComplete = function(){
        this.infoLabel.text = "";
    }
    return GameInfo;
})(ui.GameInfoUI);
//角色类
var Role = (function(_super){
    function Role(){
        Role.super(this);
        //初始化
        // this.init();
    }
    //是否缓存了动画
    Role.cached = false;
    //注册类
    Laya.class(Role,"Role",_super);
    var _proto = Role.prototype;
    _proto.init = function(_type,_camp,_hp,_speed,_hitRadius,_heroType){
        if(!_heroType)_heroType = 0;
        //角色类型
        this.type = _type;
        //阵营:0自己人，1敌人
        this.camp = _camp;
        //血量
        this.hp = _hp;
        //速度
        this.speed = _speed;
        //被击半径
        this.hitRadius = _hitRadius;
        //0普通，1子弹，2炸药，3补给品, 4技能, 5BOSS,6左边子弹,7右边子弹
        this.heroType = _heroType;

        //射击类型
        this.shootType = 0;
        //射击间隔
        this.shootInterval = 500;
        //下次射击时间
        this.shootTime = Laya.Browser.now()+2000;
        //当前动作
        this.action = "";
        //是否是子弹
        this.isBullet = false;
        //是否是物品
        this.isPackbag = false;

        //当前运动距离
        this.recDis = 0;

        if(!Role.cached){
            Role.cached = true;

            // var ani = new Laya.Animation();
            // ani.loadAtlas("res/res2D/kk_play.atlas"); // 加载图集动画
            // ani.play(); 
            // Laya.stage.addChild(ani);
            // return;


            //缓存飞机的动作
            Laya.Animation.createFrames(["war/hero_fly1.png","war/hero_fly2.png"],"hero_fly");
            Laya.Animation.createFrames(["war/hero_down1.png","war/hero_down2.png","war/hero_down3.png"],"hero_hit");
            //缓存集中爆炸动作
            Laya.Animation.createFrames(["war/hero_down1.png","war/hero_down2.png"
            ,"war/hero_down3.png","war/hero_down4.png"],"hero_down");

            //缓存敌机1飞行动作
            Laya.Animation.createFrames(["war/enemy1_fly1.png"],"enemy1_fly");
            //缓存敌机1爆炸动作
            Laya.Animation.createFrames(["war/enemy1_down1.png","war/enemy1_down2.png","war/enemy1_down3.png"
            ,"war/enemy1_down4.png"],"enemy1_down");

            //缓存敌机2飞行动作
            Laya.Animation.createFrames(["war/enemy2_fly1.png"],"enemy2_fly");
            //缓存敌机2爆炸动作
            Laya.Animation.createFrames(["war/enemy2_down1.png","war/enemy2_down2.png","war/enemy2_down3.png"
            ,"war/enemy2_down4.png"],"enemy2_down");
            //缓存敌机2碰撞动作
            Laya.Animation.createFrames(["war/enemy2_hit.png"],"enemy2_hit");

            //缓存敌机3飞行动作
            Laya.Animation.createFrames(["war/enemy3_fly1.png","war/enemy3_fly2.png"],"enemy3_fly");
            //缓存敌机3爆炸动作
            Laya.Animation.createFrames(["war/enemy3_down1.png","war/enemy3_down2.png","war/enemy3_down3.png"
            ,"war/enemy3_down4.png","war/enemy3_down5.png","war/enemy3_down6.png"],"enemy3_down");
            //缓存敌机3碰撞动作
            Laya.Animation.createFrames(["war/enemy3_hit.png"],"enemy3_hit");
            //缓存BOSS动作
            Laya.Animation.createFrames(["war/CXK1.png","war/CXK2.png","war/CXK3.png","war/CXK4.png","war/CXK5.png","war/CXK6.png","war/CXK7.png","war/CXK8.png","war/CXK9.png","war/CXK10.png","war/CXK11.png"],"boss1_fly");
            Laya.Animation.createFrames(["war/CXK_hit2.png","war/CXK_hit3.png"],"boss1_hit");
            Laya.Animation.createFrames(["war/BOSS1_down1.png","war/BOSS1_down2.png","war/BOSS1_down3.png","war/BOSS1_down4.png"],"boss1_down");
            Laya.Animation.createFrames(["war/BOSS_05.png"],"boss2_fly");
            Laya.Animation.createFrames(["war/BOSS2_next.png"],"boss2_next");
            Laya.Animation.createFrames(["war/BOSS2_hit.png"],"boss2_hit");
            Laya.Animation.createFrames(["war/BOSS_06.png","war/BOSS_06.png"],"boss2_act");
            Laya.Animation.createFrames(["war/BOSS2_down.png"],"boss2_down");
            //缓存子弹动画
            Laya.Animation.createFrames(["war/bullet1.png"],"bullet1_fly");
            Laya.Animation.createFrames(["war/bullet2.png"],"bullet2_fly");
            Laya.Animation.createFrames(["war/bullet3.png"],"bullet3_fly");
            Laya.Animation.createFrames(["war/bullet4.png"],"bullet4_fly");
            Laya.Animation.createFrames(["war/bullet3_hit.png"],"bullet3_down");
            //缓存强化包
            Laya.Animation.createFrames(["war/ufo1.png"],"ufo1_fly");
            //缓存医疗包
            Laya.Animation.createFrames(["war/ufo2.png"],"ufo2_fly");

            //缓存炸弹动画
            Laya.Animation.createFrames(["war/skill1_boom.png"],"skill1_fly");
        }
        if(!this.body){
            //创建一个动画作为飞机的身体
            this.body = new Laya.Animation();
            //把机体给添加到容器内
            this.addChild(this.body);

            this.body.on(Laya.Event.COMPLETE,this,this.onPlayComplete);
        }
        //播放飞行动画
        this.playAction("fly");
    }
    _proto.onPlayComplete = function(){
        //如果是击毁动画，则隐藏对象
        if(this.action === "down" && this.heroType != 5){
            //停止动画播放
            this.body.stop();
            //隐藏显示
            this.visible = false;
        }
        else if(this.action === "hit"){
            //如果是被击动画播放完毕，则接着播放飞行动画
            this.playAction("fly")
        }
        else if(this.action === "down" && this.heroType == 5){
            this.destroy();
        }
        else if(this.action == "act"){
            this.playAction("fly");
        }
    }
    _proto.playAction = function(action){
        //记录当前播放动画类型
        this.action = action;
        //根据类型播放动画

        this.body.play(0,true,this.type+"_"+action);

        if(this.type == "boss1")
        {
            this.body.interval = 100;
            // this.body.scale(2,2);
        }
        // else
        //     this.body.play(0,true,this.type+"_"+action);
        //获取动画大小区域
        this.bound = this.body.getBounds();
        //设置机身居中
        this.body.pos(-this.bound.width/2,-this.bound.height/2);
    }
    return Role;
})(Laya.Sprite);
//BOSS类
function BOSS(_bossLve,role){
    this.bossLve = _bossLve;
    this.shootType = [];
    this.bullet = null;
    switch(this.bossLve){
        case 1:
            // this.shootType = [-105,-75,-45,-15,15,45,75,105];
            this.shootType = [-45,-15,15,45];
            for(var index = 0;index<this.shootType.length;index++){
                    //从对象池里边创建一个子弹
                    this.bullet = Laya.Pool.getItemByClass("role",Role);
                    //初始化子弹信息
                    this.bullet.init("bullet4",role.camp,1,15,1,1);
                    // //设置角色类型为子弹类型
                    this.bullet.isBullet = true;
                    //设置子弹发射初始化位置
                    this.bullet.pos(role.x+this.shootType[index],role.y);
                    //添加舞台上
                    this.roleBox.addChild(this.bullet);
            }

            for(var i=0;i<10;i++)
            {
                this.bullet = Laya.Pool.getItemByClass("role",Role);
                //角色类型，阵营，血量，速度，被击半径，类型（子弹，boss等）
                this.bullet.init("bullet4",role.camp,1,6,1,1);
                this.bullet.isBullet = true;
                this.bullet.bulletType = 1;
                var hudu = (2*Math.PI / 360) * (i/10) * 360;
                this.bullet.hudu = hudu;
                var x = role.x + Math.sin(hudu) * 96;
                var y = role.y - Math.cos(hudu) * 96;
                this.bullet.pos(x,y);
                this.roleBox.addChild(this.bullet);
            }

            for(var j=0;j<6;j++)
            {
                this.bullet = Laya.Pool.getItemByClass("role",Role);
                this.bullet.init("bullet4",role.camp,1,6,1,1);
                this.bullet.isBullet = true;
                this.bullet.bulletType = 2;
                var hudu = (2*Math.PI / 360) * (j/10) * 360;
                this.bullet.dis = i%2>0?300:500;
                var x = role.x + Math.sin(hudu) * 96;
                var y = role.y - Math.cos(hudu) * 96;
                this.bullet.pos(x,y);
                this.roleBox.addChild(this.bullet);
            }

        break;
        case 2:
            if(role.hp >= 1000){
                this.shootType = [-75,-45,-15,15,45,75];
                for(var index = 0;index<this.shootType.length;index++){
                    //从对象池里边创建一个子弹
                    this.bullet = Laya.Pool.getItemByClass("role",Role);
                    //初始化子弹信息
                    this.bullet.init("bullet2",role.camp,1,6,1,1);
                    // //设置角色类型为子弹类型
                    this.bullet.isBullet = true;
                    //设置子弹发射初始化位置
                    this.bullet.pos(role.x+this.shootType[index],role.y);
                    if(index == 0){
                        this.bullet.skewX = -45;
                        this.bullet.skewY = 45;
                        this.bullet.heroType = 6;
                    }
                    else if(index == 1){
                        this.bullet.skewX = -30;
                        this.bullet.skewY = 30;
                        this.bullet.heroType = 6;
                    }
                    else if(index == 4){
                        this.bullet.skewX = 30;
                        this.bullet.skewY = -30;
                        this.bullet.heroType = 7;
                    }
                    else if(index == 5){
                        this.bullet.skewX = 45;
                        this.bullet.skewY = -45;
                        this.bullet.heroType = 7;
                    }
                    //添加舞台上
                    this.roleBox.addChild(this.bullet);
                }
            }
            else if(role.hp <1000){
                    if( Math.random() < 0.3){
                        this.shootType = [25,75,125,175,225,275,325,375];
                        for(var i = 0;i<8;i++){
                            //从对象池里边创建一个子弹
                            this.bullet = Laya.Pool.getItemByClass("role",Role);
                            //初始化子弹信息
                            this.bullet.init("bullet3",role.camp,2,6,40);
                            // //设置角色类型为子弹类型
                            this.bullet.isBullet = true;
                            //设置子弹发射初始化位置
                            this.bullet.pos(this.shootType[i],role.y+80);
                            //添加舞台上
                            this.roleBox.addChild(this.bullet);
                        }
                    }
                    else {
                        //从对象池里边创建一个子弹
                        this.bullet = Laya.Pool.getItemByClass("role",Role);
                        //初始化子弹信息
                        this.bullet.init("bullet3",role.camp,2,6,30);
                        // //设置角色类型为子弹类型
                        this.bullet.isBullet = true;
                        //设置子弹发射初始化位置
                        this.bullet.pos(role.x,role.y+80);
                        //添加舞台上
                        this.roleBox.addChild(this.bullet);
                    }
            }
    
            
                // Laya.timer.once(10000, this, this.anotherShoot);
        break;
    }
}

// var _proto = BOSS.prototype;

// _proto.anotherShoot = function(){

// }
//循环滚动的游戏背景
var BackGround = (function(_super){
    function BackGround(){
        BackGround.super(this);
        //创建游戏背景1
        this.bg1 = new Laya.Sprite();
        //加载并显示背景图
        this.bg1.loadImage("war/background.png");
        //把背景1放在容器中
        this.addChild(this.bg1);
        //创建游戏背景2
        this.bg2 = new Laya.Sprite();
        //加载并显示背景图
        this.bg2.loadImage("war/background.png");
        //更改背景2，放在背景1的上面
        this.bg2.pos(0,-852);
        //把背景2放在容器中
        this.addChild(this.bg2);

        //创建一个帧循环，更新容器位置
        Laya.timer.frameLoop(1,this,this.onLoop);
    }
    //注册类
    Laya.class(BackGround,"BackGround",_super);
    var _proto = BackGround.prototype;
    _proto.onLoop = function(){
        //背景容器每帧向下移动一像素
        this.y +=1;
        //如果背景图到了下面不可见的位置，立即调整位置到最上边
        if(this.bg1.y+this.y>=852){
            this.bg1.y-=852*2;
        }
        if(this.bg2.y+this.y>=852){
            this.bg2.y-=852*2;
        }
    }
    return BackGround;
})(Laya.Sprite);
// var Game = (function(){
//     (function Game(){
        //子弹发射偏移位置表
        this.bulletPos = [[0],[-15,15],[-30,0,30],[-45,-15,15,45]];
        //关卡等级
        this.level = 0;
        //本关积分成绩
        this.score = 0;
        //总成绩
        this.allScore = 0;
        //升级等级所需的成绩数量
        this.levelUpScore = 10;
        //子弹级别
        this.bulletLevel = 0;
        //关卡
        this.checkpoint = 1;
        //是否BOSS关
        this.boss = null;
        this.bossFlg = false;
        this.bossLoop = true;
        this.direct = "right";
        //敌机血量
        this.hps = [1,2,2];
        //敌机速度
        this.speeds = [3,2,1];
        //敌机被击半径
        this.radius = [15,30,60];
        //技能是否冷却
        this.skillFlg = false;
        //初始化引擎，设置游戏宽高
        //初始化微信小游戏
        Laya.MiniAdpter.init();
        Laya.init(400,852,laya.webgl.WebGL);
        Laya.stage.scaleMode = "showall";
        Laya.stage.alignH = "center";
        Laya.stage.screenMode = "vertical";
        //加载图集资源
        Laya.loader.load(["res/atlas/war.atlas","res/atlas/skill.atlas"],Laya.Handler.create(this,onLoaded),null,Laya.Loader.ATLAS);
        // Laya.loader.load("particleNew.part", Laya.Handler.create(this, onAssetsLoaded), null, Laya.Loader.JSON);
    // })();
    function onLoaded(){
        //创建循环滚动的背景
        this.bg = new BackGround();
        //把背景添加到舞台上显示出来
        Laya.stage.addChild(this.bg);

        //实例化角色容器
        this.roleBox = new Laya.Sprite();
        //添加到舞台上
        Laya.stage.addChild(this.roleBox);

        //创建游戏UI界面
        this.gameInfo = new GameInfo();
        this.gameInfo.item_skill.on(Laya.Event.MOUSE_DOWN,this,useSkill);
        Laya.stage.on(Laya.Event.MOUSE_UP,this,onMouseUp);
        //添加到舞台上
        Laya.stage.addChild(this.gameInfo);

        //创建一个主角
        this.hero = new Role();
        //添加到舞台上
        this.roleBox.addChild(this.hero);
        //创建敌人
        // createEnemy(10);
    
        //开始游戏
        restart();
    }
    function onLoop(){
        //遍历所有飞机，更改飞机状态
        for(var i = this.roleBox.numChildren-1;i>-1;i--){
            var role = this.roleBox.getChildAt(i);
            if(role && role.speed){
                //根据飞机速度更改飞机位置
                if(role.bulletType == 1)
                {
                    // var dx = this.hero.x - role.x;       
                    // var dy = this.hero.y - role.y;
                    // var rad = Math.atan2(dy,dx);
                    // var vx = role.speed * Math.cos(rad);
                    // var vy = role.speed * Math.sin(rad);
                    var vx = role.speed * Math.cos(role.hudu);
                    var vy = role.speed * Math.sin(role.hudu);

                    role.x += vx;
                    role.y += vy;
                }
                else if(role.bulletType == 2)
                {
                    if(role.recDis >= role.dis)
                    {
                        role.visible = false;
                        for(var s=0;s<2;s++)
                        {
                            var bullet = Laya.Pool.getItemByClass("role",Role);
                            bullet.init("bullet4",1,1,6,1,1);
                            bullet.isBullet = true;
                            bullet.bulletType = 1;
                            var hudu = (2*Math.PI / 360) * (i/10) * 360;
                            bullet.hudu = hudu;
                            var x = role.x + Math.sin(hudu) * 96;
                            var y = role.y - Math.cos(hudu) * 96;
                            bullet.pos(x,y);
                            this.roleBox.addChild(bullet);
                        }
                    }
                    else
                    {
                        role.y += role.speed;
                        role.recDis += role.speed;
                    }
                }
                else
                {
                    role.y+=role.speed;
                    if(role.heroType == 6){
                        role.x -= 1;
                    }
                    else if(role.heroType == 7){
                        role.x += 1;
                    }
                }  
                //如果敌机移动到显示区域以外则移除
                if(role.y>1000 || !role.visible || (role.isBullet && role.y<-20)){
                    //从舞台移除
                    role.removeSelf();
                    //回收钱重置属性信息
                    role.isBullet = false;
                    role.visible = true;
                    role.bulletType = null;
                    role.hudu = null;
                    role.dis = null;
                    role.recDis = 0;
                    //回收到对象池
                    if(role.heroType != 4){
                        role.skewX = 0;
                        role.skewY = 0;
                        Laya.Pool.recover("role",role);
                    }
                    else{
                        role.destroy();
                    }
                }
            }
            //处理发射子弹逻辑
            if(role.shootType > 0){
                //获取到当前时间
                var time = Laya.Browser.now();
                //如果当前时间大于下次射击时间
                if(time>role.shootTime){
                    //更新下次射击时间
                    role.shootTime = time+role.shootInterval;

                    //根据不同子弹类型，设置不同的数量及位置
                    this.pos = this.bulletPos[role.shootType - 1];
                    for(var index = 0;index<pos.length;index++){
                        //从对象池里边创建一个子弹
                        var bullet = Laya.Pool.getItemByClass("role",Role);
                        //初始化子弹信息
                        bullet.init("bullet1",role.camp,1,-4-role.shootType - Math.floor(this.level / 15),1,1);
                        // //设置角色类型为子弹类型
                        bullet.isBullet = true;
                        //设置子弹发射初始化位置
                        bullet.pos(role.x+pos[index],role.y-role.hitRadius - 10);
                        //添加舞台上
                        this.roleBox.addChild(bullet);
                    }
                    //发射子弹声音
                    Laya.SoundManager.playSound("res/sound/bullet.mp3");
                }
            }
            //敌机释放子弹
            if(role.type == "enemy2" || role.type == "enemy3"){
                var time = Laya.Browser.now();
                if(time > role.shootTime){
                    if(role.type == "enemy2"){
                        role.shootTime = time+900;
                    }
                    else{
                        role.shootTime = time+700;
                    }
                    //从对象池里边创建一个子弹
                    var bullet = Laya.Pool.getItemByClass("role",Role);
                    //初始化子弹信息
                    bullet.init("bullet2",role.camp,1,5 + Math.floor(this.level / 15),1,1);
                    // //设置角色类型为子弹类型
                    bullet.isBullet = true;
                    //设置子弹发射初始化位置
                    bullet.pos(role.x,role.y);
                    //添加舞台上
                    this.roleBox.addChild(bullet);
                }
            
            }
            //BOSS子弹
            if(role.heroType == 5){
                var time = Laya.Browser.now();
                if(role.type == "boss1"){
                    if(time > role.shootTime){
                        role.shootTime = time +650;
                        BOSS(1,role);
                    }
                    //BOSS移动
                    if(this.direct == "right")
                    {
                        role.x += 1;
                        if(role.x >= 350)
                        {
                            this.direct = "left";
                        }
                    }
                    else if(this.direct == "left")
                    {
                        role.x -=1;
                        if(role.x <= 50){
                            this.direct = "right";
                        }
                    }
                }
                else if(role.type == "boss2"){
                    if(role.hp >= 1000){
                        if(time > role.shootTime){
                            role.shootTime = time +600;
                            role.playAction("act");
                            role.interval = 100;
                            BOSS(2,role);
                        }
                    }
                    //BOSS半血
                    else if(role.hp < 1000){
                        role.playAction("next");
                        if(time > role.shootTime){
                            role.shootTime = time + 500;
                            BOSS(2,role);
                        }
                        if(this.direct == "right"){
                            role.x += 1;
                            if(role.x >= 350){
                                this.direct = "left";
                            }
                        }
                        else if(this.direct == "left"){
                            role.x -=1;
                            if(role.x <= 50){
                                this.direct = "right";
                            }
                        }
                    }
                }
            }
            //技能释放逻辑
            if(role.type == "skill1"){
                if(role.y <300){
                    var enmNum = 0;
                    role.destroy();
                    var skill = new Skill();
                    this.roleBox.addChild(skill);
                    skill.init(1,4,0);
                    //消灭全部敌人
                    for(var i = this.roleBox.numChildren-1;i>-1;i--){
                         var myEmy = this.roleBox.getChildAt(i);
                         if(myEmy.camp != 0){
                                lostHp(myEmy,100);
                                enmNum++;
                         }
                    }
                    //每消灭一个敌人，积分+1
                    this.score += enmNum;
                    this.allScore += enmNum;
                    showScore();
                }
                //技能10S冷却
                Laya.timer.once(20000, this, onComplete);
            }
        }
        
        //检测碰撞
        for(var i = this.roleBox.numChildren-1;i>-1;i--){
            //获取角色对象1
            var role1 = this.roleBox.getChildAt(i);
            //如果角色死亡则忽略
            if(role1.hp<1)continue;
            for(var j = i-1;j>-1;j--){
                //如果角色死亡则忽略
                if(!role1.visible)continue;
                //获取角色对象2 
                var role2 = this.roleBox.getChildAt(j);
                //如果角色未死亡，并且阵营不同，才行进碰撞
                if(role2.hp>0 && role1.camp != role2.camp && role1.heroType != 4 && role2.heroType != 4 && !(role1.heroType == 1 && role2.heroType == 1)){
                    //计算碰撞区域
                    var hitRadius = role1.hitRadius > role2.hitRadius? role1.hitRadius : role2.hitRadius;
                    //根据距离判断是否碰撞
                    if(Math.abs(role1.x-role2.x) < hitRadius && Math.abs(role1.y-role2.y) < hitRadius){
                        //判断是否吃到补给品
                        if(role1.isPackbag == true || role2.isPackbag == true){
                            if(role1.isBullet == false && role2.isBullet == false){
                                getSupply(role1);
                                getSupply(role2);
                            }
                       
                        }
                        else{
                            //碰撞后掉血
                            lostHp(role1,1);
                            lostHp(role2,1);
                                       
                            //每掉一滴血，积分+1
                            this.score++;
                            this.allScore++;
                            showScore();
                        }
                    }
                }
            }
        }
        //关卡越高，创建敌机间隔越短
        var cutTime = this.level < 30 ? this.level * 2 : 60;
        //关卡越高，敌机飞行速度越高
        var speedUp = Math.floor(this.level  / 6);
        //关卡越高，敌机血量越高
        var hpUp = Math.floor(this.level / 8);
        //关卡越高，敌机数量越多
        var numUp = Math.floor(this.level / 10);
        if(!this.bossFlg){
            //生成小飞机
            if(Laya.timer.currFrame % (80 - cutTime) === 0){
                createEnemy(0,2+numUp,3+speedUp,1);
            }
            //生成中型飞机
            if(Laya.timer.currFrame % (150 - cutTime * 4) === 0){
                createEnemy(1,1+numUp,2+speedUp,2+hpUp *2)
            }
            //生成小boss
            if(Laya.timer.currFrame % (900 -cutTime *4) === 0){
                createEnemy(2,1,1+speedUp,10+hpUp*6);
                //boss添加声音
                Laya.SoundManager.playSound("res/sound/enemy3_out.mp3");
            }
        }
        //生成关卡BOSS
        // if(this.level == 5 && this.bossFlg == true && this.bossLoop == true){
        if(this.level == 2 && this.bossFlg == true && this.bossLoop == true)
        {
            this.gameInfo.bossComing();
            this.bossLoop = false;
            if(this.checkpoint == 1){
                createBoss(0,1000,70,200,100);
            }
            else if(this.checkpoint ==2){
                createBoss(1,2000,80,200,100);
            }
        }
        //击败BOSS
        if(this.boss != null){
            //生成小飞机
            // if(Laya.timer.currFrame % 80  === 0){
            //     createEnemy(0,3,3+speedUp,1);
            // }
            // //生成中型飞机
            // if(Laya.timer.currFrame % 150  === 0){
            //     createEnemy(1,2,2+speedUp,2+hpUp *2)
            // }
            // //生成小boss
            // if(Laya.timer.currFrame % 800 === 0){
            //     createEnemy(2,1,1+speedUp,10+hpUp*6);
            // }
            if(this.boss.hp < 1){
                this.bossFlg = false;
                this.bossLoop = true;
                Laya.SoundManager.stopMusic();
                // this.boss.destroy();
                this.boss = null;
                this.checkpoint++;
                if(this.checkpoint > 2){
                    Laya.timer.clear(this,onLoop);
                    //显示提示信息
                    this.gameInfo.infoLabel.text = "恭喜通关！分数："+this.allScore+"\n点击这里重新开始。";
                    this.gameInfo.infoLabel.color = "#ffffff";
                    //注册点击事件，点击重新开始游戏
                    this.gameInfo.infoLabel.once(Laya.Event.CLICK,this,restart);
                }
                else{
                    this.gameInfo.nextTage(this.checkpoint);
                }
                this.level = 0;
                this.score = 0;
                this.levelUpScore = 0;
            }
        }
        //如果主角死亡，则停止游戏循环
        if(this.hero.hp<1){
            Laya.timer.clear(this,onLoop);
            //游戏结束声音
            Laya.SoundManager.playSound("res/sound/game_over.mp3");
            //显示提示信息
            this.gameInfo.infoLabel.text = "GameOver,分数："+this.allScore+"\n点击这里重新开始。";
            this.gameInfo.infoLabel.color = "#ffffff";
            //注册点击事件，点击重新开始游戏
            this.gameInfo.infoLabel.once(Laya.Event.CLICK,this,restart);
        }    
    }
    function lostHp(role,lostHp){
        //减血
        role.hp-=lostHp;
        if(role.hp>0){
            //如果未死亡，则播放爆炸动画
            if(role.type != "bullet3"){
                role.playAction("hit");
            }
        }
        else{
            if(role.isBullet){
                //如果是子弹，则直接隐藏
                if(role.type == "bullet3"){
                    role.playAction("down");
                }
                else{
                    role.visible = false;
                }
                
            }
            else if(!role.isPackbag){
                role.playAction("down");
                //击中boss掉落血瓶或者子弹升级道具
                if(role.type == "enemy3"){
                    //随机是子弹升级道具还是血瓶
                    var type = Math.random() < 0.7 ? 2 : 3;
                    var item = Laya.Pool.getItemByClass("role",Role);
                    //初始化信息
                    item.init("ufo" + (type - 1),role.camp,1000,1,15,type);
                    item.isPackbag = true;
                    //设置位置
                    item.pos(role.x,role.y);
                    //添加到舞台上
                    this.roleBox.addChild(item);
                }
            }
        }
        //设置主角血量值
        if(role == this.hero){
            this.gameInfo.hp(role.hp);
        }
    }
    //获取补给品
    function getSupply(role){
        if(role.heroType === 2){
            // //每吃一个子弹升级道具，子弹升级+1
            this.bulletLevel++;
            // //子弹每升2级，子弹数量增加1，最大数量限制在4个
            this.hero.shootType = Math.min(Math.floor(this.bulletLevel / 2) + 1,4);
            // //子弹级别越高，发射频率越快
            this.hero.shootInterval = 400 -20 * (this.bulletLevel > 12 ? 12 : this.bulletLevel);
            // //隐藏道具
            role.visible = false;
            // //获得道具声音
            Laya.SoundManager.playSound("res/sound/achievement.mp3");
        }
        else if(role.heroType === 3){
            //每吃一个血瓶，血量增加1
            this.hero.hp++;
            //设置主角血量
            this.gameInfo.hp(this.hero.hp);
            //设置最大血量不超过10
            if(this.hero.hp>10)this.hero.hp = 10;
            //隐藏道具
            role.visible = false;
            //获得道具声音
            Laya.SoundManager.playSound("res/sound/achievement.mp3");
        }
    }
    //释放技能
    function useSkill(){
        onMouseDown();
        if(!this.skillFlg){
            //从对象池里边创建一个炸弹
            var boom = Laya.Pool.getItemByClass("role",Role);
            //初始化炸弹信息
            boom.init("skill1",0,100,-10,1,4);
            //设置炸弹发射初始化位置
            boom.pos(200,700);
            boom.anchorX = 0.5;
            boom.anchorY = 0.5;
            //添加舞台上
            this.roleBox.addChild(boom);
            Laya.timer.loop(1000,this,skillLoop);
            this.gameInfo.item_effec.scrollRect.y = 0;
        }
        this.skillFlg = true;
        this.gameInfo.item_effec.gray = true;
        this.gameInfo.item_effec.visible = true;
    }
    function onComplete(){
        this.skillFlg = false;
        this.gameInfo.item_effec.gray = false;
        this.gameInfo.item_effec.y = 10;
        Laya.timer.clear(this,skillLoop);
    }
    //技能冷却计时
    function skillLoop(){
        if(this.gameInfo.item_effec.scrollRect.y < this.gameInfo.item_effec.height){
            this.gameInfo.item_effec.scrollRect.y -= 2.5;
            this.gameInfo.item_effec.y -=2.5;
        }
    }
    //分数显示
    function showScore(){
            this.gameInfo.score(this.allScore);
            //积分大于升级积分，则升级
            if(this.score > this.levelUpScore){
                //升级关卡
                this.level++;
                if(this.level>15) this.level = 15;
                //在UI上显示关卡等级
                this.gameInfo.level(this.level);
                //提高下一级的升级难度
                this.levelUpScore += this.level * 5;
                //进入BOSS关
                if(this.level == 2){
                    this.bossFlg = true;
                }
            }
    }
    function restart(){
        //重置游戏数据
        this.allScore = 0;
        this.score = 0;
        this.level = 0;
        this.checkpoint = 1;
        this.levelUpScore = 0;
        this.bulletLevel = 0;
        this.boss = null;
        this.bossFlg = false;
        this.skillFlg = false;
        this.gameInfo.item_skill.gray = false;
        this.gameInfo.item_effec.visible = false;
        this.gameInfo.item_effec.y = 10;
        Laya.timer.clear(this,skillLoop);
        this.gameInfo.item_effec.scrollRect = this.gameInfo.item_effec.scrollRect || new Laya.Rectangle(0,0,this.gameInfo.item_effec.width,this.gameInfo.item_effec.height);
        this.bossLoop = true;
        this.gameInfo.reset();

        //初始化角色
        this.hero.init("hero",0,50,0,30);
        //设置射击类型
        this.hero.shootType = 1;
        //设置主角位置
        this.hero.pos(200,500);
        //重置射击间隔
        this.hero.shootInterval = 500;
        //显示角色
        this.hero.visible = true;

        for(var i = this.roleBox.numChildren-1;i>-1;i--){
            var role = this.roleBox.getChildAt(i);
            if(role != this.hero){
                role.removeSelf();
                //回收之前重置
                role.visible = true;
                //回收到对象池
                if(role.heroType != 4){
                    role.skewX = 0;
                    role.skewY = 0;
                    Laya.Pool.recover("role",role);
                }
                else{
                    role.destroy();
                }
            }
        }
        //恢复游戏
        resume();
    }
    //暂停
    function pause(){
        //停止游戏主循环
        Laya.timer.clear(this,onLoop);
        //移除舞台的鼠标移动事件
        Laya.stage.off(Laya.Event.MOUSE_MOVE,this,onMouseMove);
    }
    //恢复
    function resume(){
        //在循环中创建敌人
        Laya.timer.frameLoop(1,this,onLoop);
        //监听舞台的鼠标移动事件
        Laya.stage.on(Laya.Event.MOUSE_MOVE,this,onMouseMove);
    }
    function onMouseMove(){
        //始终保持主角和鼠标位置一致
        Laya.Tween.to(this.hero,{x:Laya.stage.mouseX,y:Laya.stage.mouseY},50,null,null,0);
        // this.hero.pos(Laya.stage.mouseX,Laya.stage.mouseY);
    }
    function onMouseDown(){
        Laya.stage.off(Laya.Event.MOUSE_MOVE,this,onMouseMove);
    }
    function onMouseUp(){
        Laya.stage.on(Laya.Event.MOUSE_MOVE,this,onMouseMove);
    }
    function createEnemy(type,num,speed,hp){
        for(var i=0;i<num;i++){
            //随机出现敌人
            // var r = Math.random();
            // //根据随机数，随机敌人
            // var type = r<0.7?0:r<0.95?1:2;
            //创建敌人
            var enemy = Laya.Pool.getItemByClass("role",Role);
            //初始化角色
            enemy.init("enemy"+(type+1),1,hp,speed,this.radius[type]);
            //随机位置
            enemy.pos(Math.random()*400,-Math.random()*200 - 100);
            //添加到舞台上
            this.roleBox.addChild(enemy);
        }
    }
    function createBoss(type,hp,hitRadius,posX,posY){
        console.log("创建boss");
        this.boss = Laya.Pool.getItemByClass("role",Role);
        this.boss.init("boss"+(type+1),1,hp,0,hitRadius,5);
        this.boss.visible = true;
        this.boss.pos(posX,posY);
        this.boss.scale(2,2);
        this.roleBox.addChild(this.boss);

        //boss添加声音
        Laya.SoundManager.playMusic("res/sound/1908547769.mp3");
    }

    // function onAssetsLoaded(settings)
	// {
	// 	sp = new Laya.Particle2D(settings);
	// 	sp.emitter.start();
	// 	sp.play();
	// 	Laya.stage.addChild(sp);

	// 	sp.x = Laya.stage.width / 2;
	// 	sp.y = Laya.stage.height / 2;
    //     sp.zOrder = 10000;
	// }
// })();
